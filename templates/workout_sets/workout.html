{% extends "base.html" %}

{% block title %}–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: {{ workout_set.name }} - –î–æ–º–∞—à–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>{{ workout_set.name }}</h2>
            <div class="d-flex align-items-center">
                <span class="text-muted me-3" id="totalTime">–û–±—â–µ–µ –≤—Ä–µ–º—è: 00:00</span>
                <a href="{{ url_for('workout_sets_list') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                </a>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Ç–µ–∫—É—â–µ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary" id="currentExercisePanel" style="display: none;">
                    <div class="card-body">
                        <div class="row align-items-start">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-2">
                                    <i class="bi bi-play-circle-fill me-2"></i>
                                    <span id="currentExerciseInstruction">–í—ã–ø–æ–ª–Ω–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</span>
                                </h5>
                                <h4 class="mb-0" id="currentExerciseName">–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h4>
                                <p class="text-muted mb-0">
                                    <span id="currentExerciseReps">15</span> –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
                                </p>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-end" id="currentExerciseImages">
                                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning" id="timerCard" style="display: none;">
                    <div class="card-body text-center">
                        <h3 class="text-warning mb-2">–û—Ç–¥—ã—Ö</h3>
                        <div class="display-1 fw-bold text-warning" id="timerDisplay">00:00</div>
                        <p class="text-muted mb-0" id="timerExerciseName"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
        <div class="row" id="exercisesContainer">
            {% for exercise in exercises %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 exercise-card"
                         data-exercise-code="{{ exercise.code }}"
                         data-exercise-index="{{ loop.index0 }}"
                         data-round-count="{{ exercise.round_count }}"
                         data-rest-seconds="{{ exercise.rest_seconds }}"
                         data-exercise-name="{{ exercise.name }}"
                         data-repeat-count="{{ exercise.repeat_count }}"
                         data-exercise-images='{{ exercise.images | tojson }}'>

                        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
                        <div class="card-header bg-primary text-white text-center fw-bold exercise-header"
                             style="display: none;">
                            –¢–µ–∫—É—â–µ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
                        </div>

                        <div class="card-body">
                            <h6 class="card-title d-flex align-items-center">
                                <i class="bi bi-dumbbell me-2"></i>
                                {{ exercise.name }}
                            </h6>

                            <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
                            <div class="mb-3">
                                <span class="badge bg-info me-1">{{ exercise.round_count }} –ø–æ–¥—Ö–æ–¥–æ–≤</span>
                                <span class="badge bg-success me-1">{{ exercise.repeat_count }} —Ä–∞–∑</span>
                                <span class="badge bg-warning">{{ exercise.rest_seconds }}—Å –æ—Ç–¥—ã—Ö</span>
                            </div>

                            <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
                            {% if exercise.images %}
                                <div class="exercise-images mb-3">
                                    {% for image in exercise.images[:2] %}
                                        <img src="{{ url_for('static', filename=image) }}"
                                             class="img-thumbnail me-1"
                                             style="width: 60px; height: 60px; object-fit: cover;"
                                             alt="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
                                    {% endfor %}
                                    {% if exercise.images|length > 2 %}
                                        <span class="text-muted small">+{{ exercise.images|length - 2 }}</span>
                                    {% endif %}
                                </div>
                            {% endif %}

                            <!-- –û–ø–∏—Å–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
                            {% if exercise.description %}
                                <p class="card-text small text-muted">{{ exercise.description[:100] }}{% if exercise.description|length > 100 %}...{% endif %}</p>
                            {% endif %}
                        </div>

                        <div class="card-footer">
                            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–¥—Ö–æ–¥–æ–≤ -->
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">–ü—Ä–æ–≥—Ä–µ—Å—Å:</small>
                                    <small class="text-muted">
                                        <span class="current-round">0</span> / {{ exercise.round_count }}
                                    </small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success progress-rounds"
                                         role="progressbar"
                                         style="width: 0%"
                                         aria-valuemin="0"
                                         aria-valuemax="{{ exercise.round_count }}">
                                    </div>
                                </div>
                            </div>

                            <!-- –û—Ç–º–µ—Ç–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ -->
                            <div class="rounds-checkmarks mb-2">
                                {% for i in range(exercise.round_count) %}
                                    <i class="bi bi-circle round-check" data-round="{{ i + 1 }}"></i>
                                {% endfor %}
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–¥—ã—Ö–∞ -->
                            <button class="btn btn-warning w-100 rest-button"
                                    data-exercise-code="{{ exercise.code }}"
                                    style="display: none;"
                                    disabled>
                                <i class="bi bi-pause-circle"></i> –û—Ç–¥—ã—Ö
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-danger btn-lg" id="finishWorkoutBtn">
                    <i class="bi bi-stop-circle"></i> –ó–∞–∫–æ–Ω—á–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                </button>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
        <div class="modal fade" id="completeModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-trophy-fill me-2"></i>
                            –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!
                        </h5>
                    </div>
                    <div class="modal-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                        </div>
                        <h4>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h4>
                        <p class="text-muted">–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: <span id="finalTime"></span></p>
                        <p class="text-muted">–ö–æ–º–ø–ª–µ–∫—Å: {{ workout_set.name }}</p>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <a href="{{ url_for('workout_sets_list') }}" class="btn btn-primary">
                            <i class="bi bi-arrow-left"></i> –ö —Å–ø–∏—Å–∫—É –∫–æ–º–ø–ª–µ–∫—Å–æ–≤
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∑–≤—É–∫–æ–≤–æ–π –º–æ–¥—É–ª—å -->
<script src="{{ url_for('static', filename='js/notification-sound.js') }}"></script>

<script>
class WorkoutSession {
    constructor(exercises) {
        console.log('üî• –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä WorkoutSession –≤—ã–∑–≤–∞–Ω —Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏:', exercises);

        this.exercises = exercises;
        this.workoutSetCode = '{{ workout_set.code }}';
        this.workoutSetName = '{{ workout_set.name }}';
        this.currentExerciseIndex = 0;
        this.currentRound = 0;
        this.isResting = false;
        this.startTime = Date.now();
        this.timerInterval = null;
        this.restEndTime = null;
        this.completedRounds = {}; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        this.isWorkoutFinished = false; // –§–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏

        console.log('üî• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...');
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        this.notificationSound = new NotificationSound();
        this.notificationSound.requestNotificationPermission();

        console.log('üî• –í—ã–∑—ã–≤–∞–µ–º initializeUI...');
        this.initializeUI();
        console.log('üî• –í—ã–∑—ã–≤–∞–µ–º loadWorkoutState...');
        this.loadWorkoutState(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        console.log('üî• –í—ã–∑—ã–≤–∞–µ–º updateTotalTime...');
        this.updateTotalTime();

        console.log('üî• WorkoutSession –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }

    saveWorkoutState() {
        // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        if (this.isWorkoutFinished) {
            console.log('üî• –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
            return;
        }

        const state = {
            workoutSetCode: this.workoutSetCode,
            workoutSetName: this.workoutSetName,
            currentExerciseIndex: this.currentExerciseIndex,
            currentRound: this.currentRound,
            isResting: this.isResting,
            startTime: this.startTime,
            completedRounds: this.completedRounds,
            restEndTime: this.restEndTime
        };
        WorkoutState.save(state);
    }

    loadWorkoutState() {
        const savedState = WorkoutState.getActive();
        if (savedState) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Ç–æ–≥–æ –∂–µ –∫–æ–º–ø–ª–µ–∫—Å–∞
            if (savedState.workoutSetCode === this.workoutSetCode) {
                this.currentExerciseIndex = savedState.currentExerciseIndex || 0;
                this.currentRound = savedState.currentRound || 0;
                this.isResting = savedState.isResting || false;
                this.startTime = savedState.startTime || Date.now();
                this.completedRounds = savedState.completedRounds || {};
                this.restEndTime = savedState.restEndTime;

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
                this.restoreExercisesState();

                // –ï—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω —Ç–∞–π–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ –æ–Ω
                if (this.isResting && this.restEndTime) {
                    const remaining = this.restEndTime - Date.now();
                    if (remaining > 0) {
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ç–∞–π–º–µ—Ä
                        const currentCard = document.querySelector(`[data-exercise-index="${this.currentExerciseIndex}"]`);
                        const exerciseName = currentCard.querySelector('.card-title').textContent.trim();
                        this.showTimer(Math.ceil(remaining / 1000), exerciseName);
                        this.timerInterval = setInterval(() => {
                            this.updateTimer();
                        }, 100);
                    } else {
                        // –¢–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫, –∑–∞–≤–µ—Ä—à–∞–µ–º –æ—Ç–¥—ã—Ö
                        this.isResting = false;
                        this.restEndTime = null;
                    }
                }
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Å–∞
                WorkoutState.create(this.workoutSetCode, this.workoutSetName);
            }
        } else {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            WorkoutState.create(this.workoutSetCode, this.workoutSetName);
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ (—Å —É—á–µ—Ç–æ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
        this.setCurrentExercise(this.currentExerciseIndex);
    }

    restoreExercisesState() {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        Object.keys(this.completedRounds).forEach(exerciseIndex => {
            const rounds = this.completedRounds[exerciseIndex];
            const card = document.querySelector(`[data-exercise-index="${exerciseIndex}"]`);
            if (card && rounds > 0) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                const progressBar = card.querySelector('.progress-rounds');
                const roundCount = parseInt(card.dataset.roundCount);
                const progress = (rounds / roundCount) * 100;
                progressBar.style.width = `${progress}%`;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                card.querySelector('.current-round').textContent = rounds;

                // –û—Ç–º–µ—á–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã
                const checkmarks = card.querySelectorAll('.round-check');
                for (let i = 0; i < rounds; i++) {
                    if (checkmarks[i]) {
                        checkmarks[i].className = 'bi bi-check-circle-fill text-success round-check';
                    }
                }
            }
        });
    }

    clearWorkoutState() {
        console.log('üî• –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...');
        console.log('üî• –°–æ—Å—Ç–æ—è–Ω–∏–µ –î–û –æ—á–∏—Å—Ç–∫–∏:', localStorage.getItem('activeWorkout'));

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ü–ï–†–ï–î –æ—á–∏—Å—Ç–∫–æ–π
        this.isWorkoutFinished = true;
        console.log('üî• –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');

        // –ü—Ä—è–º–∞—è –æ—á–∏—Å—Ç–∫–∞ localStorage
        localStorage.removeItem('activeWorkout');

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        if (typeof WorkoutState !== 'undefined') {
            WorkoutState.clear();
        }

        console.log('üî• –°–æ—Å—Ç–æ—è–Ω–∏–µ –ü–û–°–õ–ï –æ—á–∏—Å—Ç–∫–∏:', localStorage.getItem('activeWorkout'));

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ù–ï–°–ö–û–õ–¨–ö–û –†–ê–ó
        console.log('üî• –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤...');

        if (typeof WorkoutState !== 'undefined') {
            // –°—Ä–∞–∑—É
            WorkoutState.updateIndicators();

            // –ß–µ—Ä–µ–∑ 100–º—Å
            setTimeout(() => {
                console.log('üî• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ 100–º—Å');
                WorkoutState.updateIndicators();
            }, 100);

            // –ß–µ—Ä–µ–∑ 500–º—Å
            setTimeout(() => {
                console.log('üî• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ 500–º—Å');
                WorkoutState.updateIndicators();
            }, 500);

            // –ß–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                console.log('üî• –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ 1—Å–µ–∫');
                WorkoutState.updateIndicators();
            }, 1000);
        }
    }

    initializeUI() {
        console.log('üî• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI...');

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.querySelectorAll('.rest-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const exerciseCode = e.target.dataset.exerciseCode;
                this.startRest(exerciseCode);
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        const finishBtn = document.getElementById('finishWorkoutBtn');
        console.log('üî• –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω–∞:', !!finishBtn);

        if (finishBtn) {
            console.log('üî• –ü–æ–¥–∫–ª—é—á–∞–µ–º –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –∫–Ω–æ–ø–∫–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è');

            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const newFinishBtn = finishBtn.cloneNode(true);
            finishBtn.parentNode.replaceChild(newFinishBtn, finishBtn);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–µ
            newFinishBtn.addEventListener('click', (e) => {
                console.log('üî• –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏!', e);
                e.preventDefault();
                e.stopPropagation();
                this.finishWorkout();
            });
        } else {
            console.error('üî• –ö–ù–û–ü–ö–ê –ó–ê–í–ï–†–®–ï–ù–ò–Ø –ù–ï –ù–ê–ô–î–ï–ù–ê!');
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        setInterval(() => this.updateTotalTime(), 1000);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            this.saveWorkoutState();
        });

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setInterval(() => {
            this.saveWorkoutState();
        }, 5000); // –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
        window.addEventListener('storage', (e) => {
            if (e.key === 'activeWorkout' && !e.newValue) {
                // –°–æ—Å—Ç–æ—è–Ω–∏–µ –±—ã–ª–æ –æ—á–∏—â–µ–Ω–æ –≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ
                console.log('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ');
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            }
        });
    }

    setCurrentExercise(index) {
        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        document.querySelectorAll('.exercise-card').forEach(card => {
            card.classList.remove('border-primary');
            card.querySelector('.exercise-header').style.display = 'none';
            card.querySelector('.rest-button').style.display = 'none';
        });

        // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
        const currentCard = document.querySelector(`[data-exercise-index="${index}"]`);

        if (currentCard) {
            currentCard.classList.add('border-primary');
            currentCard.querySelector('.exercise-header').style.display = 'block';
            currentCard.querySelector('.rest-button').style.display = 'block';
            currentCard.querySelector('.rest-button').disabled = false;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –æ—Ç–¥—ã—Ö–∞–µ–º
            if (!this.isResting) {
                this.updateCurrentExercisePanel(currentCard);
            }

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ç–µ–∫—É—â–µ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é
            currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        this.currentExerciseIndex = index;
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        this.currentRound = this.completedRounds[index] || 0;
    }

    updateCurrentExercisePanel(exerciseCard) {
        const panel = document.getElementById('currentExercisePanel');
        const exerciseName = exerciseCard.dataset.exerciseName;
        const repeatCount = exerciseCard.dataset.repeatCount;

        let exerciseImages = [];
        try {
            const imagesData = exerciseCard.dataset.exerciseImages;
            exerciseImages = JSON.parse(imagesData);
        } catch (e) {
            exerciseImages = [];
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        document.getElementById('currentExerciseInstruction').textContent = '–í—ã–ø–æ–ª–Ω–∏—Ç–µ';
        document.getElementById('currentExerciseName').textContent = exerciseName;
        document.getElementById('currentExerciseReps').textContent = repeatCount;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const imagesContainer = document.getElementById('currentExerciseImages');
        imagesContainer.innerHTML = '';

        exerciseImages.forEach((imagePath, index) => {
            if (index < 4) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const img = document.createElement('img');
                img.src = `/static/${imagePath}`;
                img.className = 'img-thumbnail me-2';
                img.style.cssText = 'width: 160px; height: 160px; object-fit: cover;';
                img.alt = '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
                imagesContainer.appendChild(img);
            }
        });

        if (exerciseImages.length > 4) {
            const moreText = document.createElement('span');
            moreText.className = 'text-muted align-self-center';
            moreText.textContent = `+${exerciseImages.length - 4}`;
            imagesContainer.appendChild(moreText);
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.style.display = 'block';

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–∞–Ω–µ–ª–∏
        setTimeout(() => {
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    }

    hideCurrentExercisePanel() {
        document.getElementById('currentExercisePanel').style.display = 'none';
    }

    startRest(exerciseCode) {
        const currentCard = document.querySelector(`[data-exercise-code="${exerciseCode}"]`);
        const restSeconds = parseInt(currentCard.dataset.restSeconds);
        const exerciseName = currentCard.querySelector('.card-title').textContent.trim();

        // –û—Ç–º–µ—á–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥
        this.markRoundCompleted(currentCard);

        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–¥—ã—Ö–∞
        currentCard.querySelector('.rest-button').disabled = true;

        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
        this.hideCurrentExercisePanel();
        this.showTimer(restSeconds, exerciseName);

        this.isResting = true;
        this.restEndTime = Date.now() + (restSeconds * 1000);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        this.saveWorkoutState();

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç
        this.timerInterval = setInterval(() => {
            this.updateTimer();
        }, 100);
    }

    markRoundCompleted(card) {
        this.currentRound++;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        this.completedRounds[this.currentExerciseIndex] = this.currentRound;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        const progressBar = card.querySelector('.progress-rounds');
        const roundCount = parseInt(card.dataset.roundCount);
        const progress = (this.currentRound / roundCount) * 100;
        progressBar.style.width = `${progress}%`;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        card.querySelector('.current-round').textContent = this.currentRound;

        // –û—Ç–º–µ—á–∞–µ–º –≥–∞–ª–æ—á–∫–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥
        const checkmarks = card.querySelectorAll('.round-check');
        if (checkmarks[this.currentRound - 1]) {
            checkmarks[this.currentRound - 1].className = 'bi bi-check-circle-fill text-success round-check';
        }
    }

    showTimer(seconds, exerciseName) {
        const timerCard = document.getElementById('timerCard');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerExerciseNameEl = document.getElementById('timerExerciseName');

        timerCard.style.display = 'block';
        timerExerciseNameEl.textContent = exerciseName;
        this.updateTimerDisplay(seconds);

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ç–∞–π–º–µ—Ä—É
        timerCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    hideTimer() {
        document.getElementById('timerCard').style.display = 'none';
    }

    updateTimer() {
        const remaining = Math.max(0, this.restEndTime - Date.now());
        const seconds = Math.ceil(remaining / 1000);

        this.updateTimerDisplay(seconds);

        if (remaining <= 0) {
            this.endRest();
        }
    }

    updateTimerDisplay(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        const timeString = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        document.getElementById('timerDisplay').textContent = timeString;
    }

    endRest() {
        clearInterval(this.timerInterval);
        this.hideTimer();
        this.isResting = false;
        this.restEndTime = null;

        // –ó–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        this.notificationSound.createDoubleBeep();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫–æ–Ω—á–µ–Ω—ã –ª–∏ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã —Ç–µ–∫—É—â–µ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        const currentCard = document.querySelector(`[data-exercise-index="${this.currentExerciseIndex}"]`);
        const roundCount = parseInt(currentCard.dataset.roundCount);

        if (this.currentRound >= roundCount) {
            // –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
            setTimeout(() => {
                this.moveToNextExercise();
            }, 1000); // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è
        } else {
            // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–¥—ã—Ö–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            currentCard.querySelector('.rest-button').disabled = false;
            this.updateCurrentExercisePanel(currentCard);
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        this.saveWorkoutState();
    }

    moveToNextExercise() {
        if (this.currentExerciseIndex + 1 >= this.exercises.length) {
            // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            this.completeWorkout();
        } else {
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é
            this.setCurrentExercise(this.currentExerciseIndex + 1);
            this.saveWorkoutState();
        }
    }

    updateTotalTime() {
        const elapsed = Date.now() - this.startTime;
        const totalSeconds = Math.floor(elapsed / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('totalTime').textContent = `–û–±—â–µ–µ –≤—Ä–µ–º—è: ${timeString}`;
    }

    getCompletedExercises() {
        /**
         * –°–æ–±–∏—Ä–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –∫–æ–¥–æ–≤ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω—ã
         */
        const completedExercises = [];

        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –æ–Ω–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é
        this.exercises.forEach((exercise, index) => {
            const completedRounds = this.completedRounds[index] || 0;
            const totalRounds = exercise.round_count;

            // –°—á–∏—Ç–∞–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º, –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã
            if (completedRounds >= totalRounds) {
                completedExercises.push(exercise.code);
            }
        });

        console.log('üî• –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:', completedExercises);
        return completedExercises;
    }

    finishWorkout() {
        console.log('üî• finishWorkout() –≤—ã–∑–≤–∞–Ω');
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) {
            console.log('üî• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');

            // –°—Ä–∞–∑—É –æ—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            this.clearWorkoutState();

            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å –∏ —Ç–∞–π–º–µ—Ä
            this.hideCurrentExercisePanel();
            if (this.timerInterval) {
                clearInterval(this.timerInterval);
                this.hideTimer();
            }

            const totalDuration = Math.floor((Date.now() - this.startTime) / 1000);

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
            const minutes = Math.floor(totalDuration / 60);
            const seconds = totalDuration % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('finalTime').textContent = timeString;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
            fetch(`/workout-sets/{{ workout_set.code }}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    duration_seconds: totalDuration,
                    completed_exercises: this.getCompletedExercises()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', data.message);
                } else {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', data.error);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            const completeModal = new bootstrap.Modal(document.getElementById('completeModal'));
            completeModal.show();
        } else {
            console.log('üî• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');
        }
    }

    completeWorkout() {
        console.log('üî• completeWorkout() - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        this.isWorkoutFinished = true;
        console.log('üî• –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)');

        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
        this.hideCurrentExercisePanel();

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
            this.hideTimer();
        }

        // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å—Ä–∞–∑—É
        this.clearWorkoutState();

        const totalDuration = Math.floor((Date.now() - this.startTime) / 1000);

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
        const minutes = Math.floor(totalDuration / 60);
        const seconds = totalDuration % 60;
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('finalTime').textContent = timeString;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        fetch(`/workout-sets/{{ workout_set.code }}/complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                duration_seconds: totalDuration,
                completed_exercises: this.getCompletedExercises()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', data.message);
            } else {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        const completeModal = new bootstrap.Modal(document.getElementById('completeModal'));
        completeModal.show();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    console.log('üî• DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...');

    const exercises = {{ exercises | tojson }};
    console.log('üî• –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:', exercises);

    try {
        console.log('üî• –°–æ–∑–¥–∞–µ–º WorkoutSession...');
        window.workoutSession = new WorkoutSession(exercises);
        console.log('üî• WorkoutSession —Å–æ–∑–¥–∞–Ω:', !!window.workoutSession);
    } catch (error) {
        console.error('üî• –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WorkoutSession:', error);
    }

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    window.forceResetWorkout = function() {
        console.log('üî• –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');

        // –û—á–∏—â–∞–µ–º localStorage –Ω–∞–ø—Ä—è–º—É—é
        localStorage.removeItem('activeWorkout');
        localStorage.clear(); // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ—á–∏—â–∞–µ–º –≤–µ—Å—å localStorage

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        if (typeof WorkoutState !== 'undefined') {
            WorkoutState.updateIndicators();
        }

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
        setTimeout(() => {
            window.location.reload();
        }, 500);

        console.log('üî• –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        alert('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–µ–Ω–æ! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
    };

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    window.testFinishButton = function() {
        console.log('üî• –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...');
        const btn = document.getElementById('finishWorkoutBtn');
        console.log('üî• –ö–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞:', !!btn);
        if (btn) {
            console.log('üî• –ò–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫...');
            btn.click();
        } else {
            console.error('üî• –ö–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    window.checkWorkoutState = function() {
        const state = localStorage.getItem('activeWorkout');
        console.log('üî• –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', state);
        if (state) {
            try {
                const parsed = JSON.parse(state);
                console.log('üî• –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', parsed);
            } catch (e) {
                console.error('üî• –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
            }
        } else {
            console.log('üî• –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É—Å—Ç–æ–µ');
        }
    };
});
</script>

<style>
.exercise-card {
    transition: all 0.3s ease;
}

.exercise-card.border-primary {
    box-shadow: 0 0 15px rgba(13, 110, 253, 0.3);
}

.rounds-checkmarks {
    display: flex;
    justify-content: center;
    gap: 5px;
}

.round-check {
    font-size: 1.2rem;
    color: #6c757d;
}

#timerCard {
    animation: pulse 2s infinite;
}

#currentExercisePanel {
    animation: slideIn 0.5s ease-out;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.exercise-images img {
    border-radius: 4px;
}
</style>
{% endblock %}